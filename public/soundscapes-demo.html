<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Procedural Soundscapes - Water + Insects</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0a1628 0%, #1a2f4a 50%, #0d2818 100%);
      color: #e0e8f0;
      min-height: 100vh;
      padding: 20px;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 8px;
      font-size: 1.8rem;
      background: linear-gradient(90deg, #4ecdc4, #44b89d, #7ab8a8);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .subtitle {
      text-align: center;
      color: #6a8090;
      margin-bottom: 20px;
      font-size: 0.85rem;
    }
    
    .container { max-width: 900px; margin: 0 auto; }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      background: rgba(0,0,0,0.3);
      padding: 6px;
      border-radius: 12px;
    }
    
    .tab-btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: #8898a8;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .tab-btn:hover { background: rgba(78, 205, 196, 0.1); color: #a0b0c0; }
    .tab-btn.active { background: rgba(78, 205, 196, 0.25); color: #4ecdc4; }
    .tab-btn.active.water { background: rgba(64, 164, 223, 0.25); color: #40a4df; }
    .tab-btn.active.insects { background: rgba(168, 208, 96, 0.25); color: #a8d060; }
    .tab-btn.active.mix { background: rgba(200, 160, 220, 0.25); color: #c8a0dc; }
    
    /* Sections */
    .section {
      background: rgba(15, 30, 50, 0.8);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid rgba(78, 205, 196, 0.15);
    }
    
    .section h2 {
      margin-bottom: 15px;
      font-size: 0.95rem;
      color: #7898a8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .section.water h2 { color: #40a4df; }
    .section.insects h2 { color: #a8d060; }
    .section.mix h2 { color: #c8a0dc; }
    
    /* Tab content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Transport controls */
    .transport {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .transport-btn {
      padding: 14px 36px;
      border: 2px solid #4ecdc4;
      border-radius: 30px;
      background: transparent;
      color: #4ecdc4;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .transport-btn:hover { background: rgba(78, 205, 196, 0.15); }
    .transport-btn.playing { background: #4ecdc4; color: #0a1628; }
    .transport-btn.stop { border-color: #e06060; color: #e06060; }
    .transport-btn.stop:hover { background: rgba(224, 96, 96, 0.15); }
    
    /* Presets */
    .presets {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .preset-btn {
      padding: 10px 18px;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 20px;
      background: rgba(255,255,255,0.05);
      color: #b0c0d0;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    
    .preset-btn:hover { border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); }
    .preset-btn.active { background: #4ecdc4; color: #0a1628; border-color: #4ecdc4; font-weight: 600; }
    .preset-btn.active.water { background: #40a4df; border-color: #40a4df; }
    .preset-btn.active.insects { background: #a8d060; border-color: #a8d060; color: #1a2f1a; }
    
    /* Controls */
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .control-group label {
      font-size: 0.8rem;
      color: #8898a8;
      display: flex;
      justify-content: space-between;
    }
    
    .control-group label span { color: #4ecdc4; font-weight: 500; }
    .control-group.water label span { color: #40a4df; }
    .control-group.insects label span { color: #a8d060; }
    
    .control-group input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      -webkit-appearance: none;
      appearance: none;
      background: rgba(255,255,255,0.1);
    }
    
    .control-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #4ecdc4;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(78, 205, 196, 0.4);
    }
    
    .control-group.water input[type="range"]::-webkit-slider-thumb { background: #40a4df; box-shadow: 0 2px 8px rgba(64, 164, 223, 0.4); }
    .control-group.insects input[type="range"]::-webkit-slider-thumb { background: #a8d060; box-shadow: 0 2px 8px rgba(168, 208, 96, 0.4); }

    .water-readout {
      margin-top: 14px;
      padding: 12px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.22);
      border: 1px solid rgba(64, 164, 223, 0.25);
      font-size: 0.78rem;
      color: #8ea4b8;
      line-height: 1.45;
    }

    .water-readout .value {
      color: #40a4df;
      font-weight: 600;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #8898a8;
      font-size: 0.8rem;
      margin-bottom: 10px;
    }
    
    /* Advanced section */
    .advanced-toggle {
      background: none;
      border: none;
      color: #6080a0;
      cursor: pointer;
      font-size: 0.8rem;
      padding: 8px 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .advanced-toggle:hover { color: #80a0c0; }
    .advanced-toggle .arrow { transition: transform 0.2s; }
    .advanced-toggle.open .arrow { transform: rotate(90deg); }
    
    .advanced-content {
      display: none;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .advanced-content.open { display: block; }
    
    /* Debug Panel */
    .debug-panel {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.9);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px 16px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 11px;
      z-index: 1000;
      min-width: 220px;
      display: none;
    }
    
    .debug-panel.visible { display: block; }
    
    .debug-panel h4 {
      color: #0ff;
      margin: 0 0 10px 0;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .debug-row {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
      color: #888;
    }
    
    .debug-row .value { color: #0f0; }
    .debug-row .value.warn { color: #ff0; }
    .debug-row .value.error { color: #f00; }
    
    .debug-section {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #333;
    }
    
    .debug-section-title {
      color: #888;
      font-size: 10px;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    
    /* Meters */
    .meter-container {
      display: flex;
      gap: 4px;
      height: 60px;
      align-items: flex-end;
      margin-top: 6px;
    }
    
    .meter {
      flex: 1;
      background: #111;
      border-radius: 2px;
      position: relative;
      overflow: hidden;
    }
    
    .meter-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, #0f0, #ff0 80%, #f00 95%);
      transition: height 0.05s;
    }
    
    .meter-peak {
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      background: #fff;
      transition: bottom 0.1s;
    }
    
    .meter-label {
      font-size: 9px;
      text-align: center;
      color: #666;
      margin-top: 2px;
    }
    
    /* Debug toggle button */
    .debug-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      border: 1px solid #444;
      border-radius: 4px;
      padding: 6px 12px;
      color: #888;
      cursor: pointer;
      font-size: 11px;
      font-family: monospace;
      z-index: 999;
    }
    
    .debug-toggle:hover { color: #0f0; border-color: #0f0; }
    
    /* Seed input */
    .seed-input {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    .seed-input input {
      background: #111;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 4px 8px;
      color: #0f0;
      font-family: monospace;
      font-size: 11px;
      width: 100px;
    }
    
    .seed-input button {
      background: #222;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 4px 8px;
      color: #888;
      cursor: pointer;
      font-size: 10px;
    }
    
    .seed-input button:hover { color: #fff; border-color: #666; }
    
    /* Mix controls */
    .mix-levels {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .level-group {
      padding: 16px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }
    
    .level-group h3 {
      font-size: 0.85rem;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .level-group.water h3 { color: #40a4df; }
    .level-group.insects h3 { color: #a8d060; }
    
    /* Status */
    .status {
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.85rem;
    }
    
    .status.loading { background: rgba(100, 120, 200, 0.2); color: #8090c0; }
    .status.ready { background: rgba(78, 205, 196, 0.15); color: #4ecdc4; }
    .status.error { background: rgba(224, 96, 96, 0.2); color: #e06060; }
    
    /* Save/Load */
    .save-load {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .save-load button {
      padding: 8px 16px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      background: rgba(255,255,255,0.05);
      color: #8898a8;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    
    .save-load button:hover { background: rgba(255,255,255,0.1); color: #b0c0d0; }
    
    /* Links */
    .links {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .links a {
      color: #6080a0;
      text-decoration: none;
      font-size: 0.8rem;
      margin: 0 12px;
    }
    
    .links a:hover { color: #80a0c0; }
    
    /* Responsive */
    @media (max-width: 600px) {
      .controls { grid-template-columns: 1fr; }
      .mix-levels { grid-template-columns: 1fr; }
      .transport-btn { padding: 12px 24px; font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <!-- Debug Toggle -->
  <button class="debug-toggle" id="debug-toggle">üîß Debug</button>
  
  <!-- Debug Panel -->
  <div class="debug-panel" id="debug-panel">
    <h4>‚ö° Debug Info</h4>
    
    <div class="debug-section">
      <div class="debug-section-title">System</div>
      <div class="debug-row"><span>Sample Rate:</span><span class="value" id="dbg-sr">--</span></div>
      <div class="debug-row"><span>Block Time:</span><span class="value" id="dbg-block">--</span></div>
    </div>
    
    <div class="debug-section">
      <div class="debug-section-title">Water Engine</div>
      <div class="debug-row"><span>Active Voices:</span><span class="value" id="dbg-water-voices">0/32</span></div>
      <div class="debug-row"><span>Events/sec:</span><span class="value" id="dbg-water-events">0</span></div>
    </div>
    
    <div class="debug-section">
      <div class="debug-section-title">Insects Engine</div>
      <div class="debug-row"><span>Active Voices:</span><span class="value" id="dbg-insect-voices">0</span></div>
      <div class="debug-row"><span>Engine:</span><span class="value" id="dbg-insect-engine">--</span></div>
    </div>
    
    <div class="debug-section">
      <div class="debug-section-title">Meters (dBFS)</div>
      <div class="debug-row"><span>Peak L/R:</span><span class="value" id="dbg-peak">-‚àû / -‚àû</span></div>
      <div class="debug-row"><span>RMS L/R:</span><span class="value" id="dbg-rms">-‚àû / -‚àû</span></div>
      <div class="meter-container">
        <div class="meter" id="meter-l"><div class="meter-fill" id="meter-fill-l"></div><div class="meter-peak" id="meter-peak-l"></div></div>
        <div class="meter" id="meter-r"><div class="meter-fill" id="meter-fill-r"></div><div class="meter-peak" id="meter-peak-r"></div></div>
      </div>
      <div style="display:flex;justify-content:space-around;"><span class="meter-label">L</span><span class="meter-label">R</span></div>
    </div>
    
    <div class="debug-section">
      <div class="debug-section-title">Seed</div>
      <div class="seed-input">
        <input type="text" id="seed-input" value="12345">
        <button id="seed-apply">Apply</button>
        <button id="seed-random">Random</button>
      </div>
    </div>
  </div>
  
  <div class="container">
    <h1>üåä Procedural Soundscapes ü¶ó</h1>
    <p class="subtitle">High-quality ambient water and insect synthesis</p>
    
    <div class="links">
      <a href="ARCHIVE/plaits-modal-demo.html">‚Üê Plaits Modal</a>
      <a href="fm-modal-demo.html">FM Synth ‚Üí</a>
    </div>
    
    <div class="status loading" id="status">Loading worklets...</div>
    
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn water active" data-tab="water">üíß Water</button>
      <button class="tab-btn insects" data-tab="insects">ü¶ó Insects</button>
      <button class="tab-btn mix" data-tab="mix">üéöÔ∏è Mix</button>
    </div>
    
    <!-- Transport -->
    <div class="transport">
      <button class="transport-btn" id="play-btn">‚ñ∂ Start</button>
      <button class="transport-btn stop" id="stop-btn">‚óº Stop</button>
    </div>
    
    <!-- Water Tab -->
    <div class="tab-content active" id="tab-water">
      <div class="section water">
        <h2>Water Preset</h2>
        <div class="presets" id="water-presets">
          <button class="preset-btn water active" data-preset="tapDrips">üíß Tap Drips</button>
          <button class="preset-btn water" data-preset="stream">üèûÔ∏è Stream</button>
          <button class="preset-btn water" data-preset="waterfall">üåä Waterfall</button>
          <button class="preset-btn water" data-preset="rainWindow">üåßÔ∏è Rain on Window</button>
        </div>
      </div>
      
      <div class="section water">
        <h2>Water Controls</h2>
        <div class="controls">
          <div class="control-group water">
            <label>Intensity <span id="water-intensity-val">50%</span></label>
            <input type="range" id="water-intensity" min="0" max="1" step="0.01" value="0.5">
          </div>
          <div class="control-group water">
            <label>Rate <span id="water-rate-val">50%</span></label>
            <input type="range" id="water-rate" min="0" max="1" step="0.01" value="0.5">
          </div>
          <div class="control-group water">
            <label>Distance <span id="water-distance-val">30%</span></label>
            <input type="range" id="water-distance" min="0" max="1" step="0.01" value="0.3">
          </div>
          <div class="control-group water">
            <label>Space (Reverb) <span id="water-space-val">30%</span></label>
            <input type="range" id="water-space" min="0" max="1" step="0.01" value="0.3">
          </div>
          <div class="control-group water">
            <label>Reverb Send <span id="water-send-val">50%</span></label>
            <input type="range" id="water-send" min="0" max="1" step="0.01" value="0.5">
          </div>
          <div class="control-group water">
            <label>Base Freq <span id="water-basefreq-val">2500 Hz</span></label>
            <input type="range" id="water-basefreq" min="600" max="6000" step="10" value="2500">
          </div>
        </div>

        <div class="water-readout" id="water-freq-readout">
          <div>Preset base: <span class="value" id="water-live-preset-base">2500 Hz</span></div>
          <div>Active base: <span class="value" id="water-live-active-base">2500 Hz</span></div>
          <div>Drop freq (pre-BP): <span class="value" id="water-live-drop-range">750‚Äì1750 Hz</span></div>
          <div>After BP filter: <span class="value" id="water-live-bp-range">1000‚Äì16000 Hz</span></div>
          <div>Estimated drop amplitude: <span class="value" id="water-live-amp">--</span></div>
        </div>
        
        <button class="advanced-toggle" id="water-advanced-toggle">
          <span class="arrow">‚ñ∂</span> Advanced
        </button>
        <div class="advanced-content" id="water-advanced">
          <div class="controls">
            <div class="control-group water">
              <label>Drop Size <span id="water-dropsize-val">50%</span></label>
              <input type="range" id="water-dropsize" min="0" max="1" step="0.01" value="0.5">
            </div>
            <div class="control-group water">
              <label>Hardness <span id="water-hardness-val">50%</span></label>
              <input type="range" id="water-hardness" min="0" max="1" step="0.01" value="0.5">
            </div>
            <div class="control-group water" id="water-glass-group" style="display:none;">
              <label>Glass Thickness <span id="water-glass-val">50%</span></label>
              <input type="range" id="water-glass" min="0" max="1" step="0.01" value="0.5">
            </div>
          </div>
        </div>
        
        <button class="advanced-toggle" id="water-layers-toggle">
          <span class="arrow">‚ñ∂</span> Layer Mix
        </button>
        <div class="advanced-content" id="water-layers">
          <div class="save-load" style="margin-bottom: 12px;">
            <button id="water-boost-toggle">‚ö° Water Boost: On</button>
          </div>
          <div class="controls">
            <div class="control-group water">
              <label>Hard Drops <span id="layer-harddrops-val">70%</span></label>
              <input type="range" id="layer-harddrops" min="0" max="1" step="0.01" value="0.7">
            </div>
            <div class="control-group water">
              <label>Water Drops <span id="layer-waterdrops-val">50%</span></label>
              <input type="range" id="layer-waterdrops" min="0" max="1.5" step="0.01" value="0.5">
            </div>
            <div class="control-group water">
              <label>Turbulence <span id="layer-turbulence-val">30%</span></label>
              <input type="range" id="layer-turbulence" min="0" max="1" step="0.01" value="0.3">
            </div>
            <div class="control-group water">
              <label>Bubbling <span id="layer-bubbling-val">0%</span></label>
              <input type="range" id="layer-bubbling" min="0" max="1.5" step="0.01" value="0.0">
            </div>
            <div class="control-group water">
              <label>Roar <span id="layer-roar-val">0%</span></label>
              <input type="range" id="layer-roar" min="0" max="1" step="0.01" value="0.0">
            </div>
            <div class="control-group water">
              <label>Rivulets <span id="layer-rivulets-val">0%</span></label>
              <input type="range" id="layer-rivulets" min="0" max="1" step="0.01" value="0.0">
            </div>

            <div class="control-group water">
              <label>Hard Drops Density <span id="density-harddrops-val">50%</span></label>
              <input type="range" id="density-harddrops" min="0" max="2" step="0.01" value="0.5">
            </div>
            <div class="control-group water">
              <label>Water Drops Density <span id="density-waterdrops-val">50%</span></label>
              <input type="range" id="density-waterdrops" min="0" max="16" step="0.01" value="0.5">
            </div>
            <div class="control-group water">
              <label>Turbulence Density <span id="density-turbulence-val">50%</span></label>
              <input type="range" id="density-turbulence" min="0" max="2" step="0.01" value="0.5">
            </div>
            <div class="control-group water">
              <label>Bubbling Density <span id="density-bubbling-val">50%</span></label>
              <input type="range" id="density-bubbling" min="0" max="2" step="0.01" value="0.5">
            </div>
            <div class="control-group water">
              <label>Roar Density <span id="density-roar-val">50%</span></label>
              <input type="range" id="density-roar" min="0" max="2" step="0.01" value="0.5">
            </div>
            <div class="control-group water">
              <label>Rivulets Density <span id="density-rivulets-val">50%</span></label>
              <input type="range" id="density-rivulets" min="0" max="2" step="0.01" value="0.5">
            </div>
          </div>
        </div>

        <button class="advanced-toggle" id="water-ocean-toggle">
          <span class="arrow">‚ñ∂</span> Ocean Layer (Alternative)
        </button>
        <div class="advanced-content" id="water-ocean">
          <div class="checkbox-row">
            <input type="checkbox" id="ocean-enabled" checked>
            <label for="ocean-enabled">Enable Ocean Worklet Layer</label>
          </div>
          <div class="controls">
            <div class="control-group water">
              <label>Ocean Level <span id="ocean-level-val">40%</span></label>
              <input type="range" id="ocean-level" min="0" max="1" step="0.01" value="0.4">
            </div>
            <div class="control-group water">
              <label>Intensity <span id="ocean-intensity-val">50%</span></label>
              <input type="range" id="ocean-intensity" min="0" max="1" step="0.01" value="0.5">
            </div>
            <div class="control-group water">
              <label>Duration Min <span id="ocean-waveDurationMin-val">4.0</span></label>
              <input type="range" id="ocean-waveDurationMin" min="2" max="15" step="0.1" value="4">
            </div>
            <div class="control-group water">
              <label>Duration Max <span id="ocean-waveDurationMax-val">10.0</span></label>
              <input type="range" id="ocean-waveDurationMax" min="2" max="15" step="0.1" value="10">
            </div>
            <div class="control-group water">
              <label>Interval Min <span id="ocean-waveIntervalMin-val">5.0</span></label>
              <input type="range" id="ocean-waveIntervalMin" min="3" max="20" step="0.1" value="5">
            </div>
            <div class="control-group water">
              <label>Interval Max <span id="ocean-waveIntervalMax-val">12.0</span></label>
              <input type="range" id="ocean-waveIntervalMax" min="3" max="20" step="0.1" value="12">
            </div>
            <div class="control-group water">
              <label>Wave2 Offset Min <span id="ocean-wave2OffsetMin-val">2.0</span></label>
              <input type="range" id="ocean-wave2OffsetMin" min="0" max="10" step="0.1" value="2">
            </div>
            <div class="control-group water">
              <label>Wave2 Offset Max <span id="ocean-wave2OffsetMax-val">6.0</span></label>
              <input type="range" id="ocean-wave2OffsetMax" min="0" max="10" step="0.1" value="6">
            </div>
            <div class="control-group water">
              <label>Foam Min <span id="ocean-foamMin-val">20%</span></label>
              <input type="range" id="ocean-foamMin" min="0" max="1" step="0.01" value="0.2">
            </div>
            <div class="control-group water">
              <label>Foam Max <span id="ocean-foamMax-val">50%</span></label>
              <input type="range" id="ocean-foamMax" min="0" max="1" step="0.01" value="0.5">
            </div>
            <div class="control-group water">
              <label>Depth Min <span id="ocean-depthMin-val">30%</span></label>
              <input type="range" id="ocean-depthMin" min="0" max="1" step="0.01" value="0.3">
            </div>
            <div class="control-group water">
              <label>Depth Max <span id="ocean-depthMax-val">70%</span></label>
              <input type="range" id="ocean-depthMax" min="0" max="1" step="0.01" value="0.7">
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Insects Tab -->
    <div class="tab-content" id="tab-insects">
      <div class="section insects">
        <h2>Insect Preset</h2>
        <div class="presets" id="insect-presets">
          <button class="preset-btn insects active" data-preset="cricket">ü¶ó Cricket</button>
          <button class="preset-btn insects" data-preset="treeCricket">üå≤ Tree Cricket</button>
          <button class="preset-btn insects" data-preset="katydid">üåø Katydid</button>
          <button class="preset-btn insects" data-preset="cicada">‚òÄÔ∏è Cicada</button>
          <button class="preset-btn insects" data-preset="grasshopper">ü¶ó Grasshopper</button>
          <button class="preset-btn insects" data-preset="moleCricket">üï≥Ô∏è Mole Cricket</button>
        </div>
      </div>
      
      <div class="section insects">
        <h2>Insect Controls</h2>
        <div class="controls">
          <div class="control-group insects">
            <label>Density <span id="insect-density-val">50%</span></label>
            <input type="range" id="insect-density" min="0" max="1" step="0.01" value="0.5">
          </div>
          <div class="control-group insects">
            <label>Temperature <span id="insect-temp-val">50%</span></label>
            <input type="range" id="insect-temp" min="0" max="1" step="0.01" value="0.5">
          </div>
          <div class="control-group insects">
            <label>Distance <span id="insect-distance-val">30%</span></label>
            <input type="range" id="insect-distance" min="0" max="1" step="0.01" value="0.3">
          </div>
          <div class="control-group insects">
            <label>Space (Reverb) <span id="insect-space-val">30%</span></label>
            <input type="range" id="insect-space" min="0" max="1" step="0.01" value="0.3">
          </div>
        </div>
        
        <button class="advanced-toggle" id="insect-advanced-toggle">
          <span class="arrow">‚ñ∂</span> Advanced
        </button>
        <div class="advanced-content" id="insect-advanced">
          <div class="controls">
            <div class="control-group insects" id="insect-proximity-group">
              <label>Proximity <span id="insect-proximity-val">50%</span></label>
              <input type="range" id="insect-proximity" min="0" max="1" step="0.01" value="0.5">
            </div>
            <div class="control-group insects" id="insect-antiphony-group" style="display:none;">
              <label>Antiphony <span id="insect-antiphony-val">30%</span></label>
              <input type="range" id="insect-antiphony" min="0" max="1" step="0.01" value="0.3">
            </div>
            <div class="control-group insects" id="insect-clickrate-group" style="display:none;">
              <label>Click Rate <span id="insect-clickrate-val">30%</span></label>
              <input type="range" id="insect-clickrate" min="0" max="1" step="0.01" value="0.3">
            </div>
            <div class="control-group insects" id="insect-motion-group" style="display:none;">
              <label>Motion <span id="insect-motion-val">50%</span></label>
              <input type="range" id="insect-motion" min="0" max="1" step="0.01" value="0.5">
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Mix Tab -->
    <div class="tab-content" id="tab-mix">
      <div class="section mix">
        <h2>Mix Levels</h2>
        <div class="mix-levels">
          <div class="level-group water">
            <h3>üíß Water Level</h3>
            <div class="control-group water">
              <label>Level <span id="mix-water-val">70%</span></label>
              <input type="range" id="mix-water" min="0" max="1" step="0.01" value="0.7">
            </div>
          </div>
          <div class="level-group insects">
            <h3>ü¶ó Insects Level</h3>
            <div class="control-group insects">
              <label>Level <span id="mix-insects-val">70%</span></label>
              <input type="range" id="mix-insects" min="0" max="1" step="0.01" value="0.7">
            </div>
          </div>
        </div>
      </div>
      
      <div class="section mix">
        <h2>Scene Controls</h2>
        <div class="controls">
          <div class="control-group">
            <label>Shared Space <span id="mix-space-val">40%</span></label>
            <input type="range" id="mix-space" min="0" max="1" step="0.01" value="0.4">
          </div>
          <div class="control-group">
            <label>Scene Size <span id="mix-size-val">50%</span></label>
            <input type="range" id="mix-size" min="0" max="1" step="0.01" value="0.5">
          </div>
          <div class="control-group">
            <label>Night EQ (HF Rolloff) <span id="mix-night-val">0%</span></label>
            <input type="range" id="mix-night" min="0" max="1" step="0.01" value="0">
          </div>
        </div>
      </div>
      
      <div class="section mix">
        <h2>Save / Load Preset</h2>
        <div class="save-load">
          <button id="save-preset">üíæ Save Preset</button>
          <button id="load-preset">üìÇ Load Preset</button>
          <button id="copy-preset">üìã Copy to Clipboard</button>
        </div>
        <input type="file" id="load-file" accept=".json" style="display:none;">
      </div>
    </div>
  </div>
  
  <script>
    // ============================================
    // AUDIO ENGINE
    // ============================================
    
    let audioContext = null;
    let waterNode = null;
    let oceanNode = null;
    let insectsNode = null;
    let reverbNode = null;
    let masterGain = null;
    let waterGain = null;
    let oceanGain = null;
    let insectsGain = null;
    let waterSendGain = null;
    let oceanSendGain = null;
    let insectsSendGain = null;
    let analyserL = null;
    let analyserR = null;
    let splitter = null;
    let nightFilter = null;
    
    let isPlaying = false;
    let currentSeed = 12345;
    let waterBoostEnabled = true;
    const WATER_PRESET_BASE_FREQ = {
      tapDrips: 2500,
      stream: 2300,
      waterfall: 4500,
      rainWindow: 2100,
    };

    const WATER_DROP_BANDPASS = {
      highpass: 1000,
      lowpass: 16000,
    };
    
    // State
    const state = {
      waterPreset: 'tapDrips',
      insectPreset: 'cricket',
      water: {
        intensity: 0.5,
        rate: 0.5,
        distance: 0.3,
        space: 0.3,
        reverbSend: 0.5,
        baseFreq: 2500,
        dropSize: 0.5,
        hardness: 0.5,
        glassThickness: 0.5,
      },
      ocean: {
        enabled: true,
        level: 0.4,
        intensity: 0.5,
        waveDurationMin: 4,
        waveDurationMax: 10,
        waveIntervalMin: 5,
        waveIntervalMax: 12,
        wave2OffsetMin: 2,
        wave2OffsetMax: 6,
        foamMin: 0.2,
        foamMax: 0.5,
        depthMin: 0.3,
        depthMax: 0.7,
      },
      // Layer mix levels
      layers: {
        hardDrops: 0.7,
        waterDrops: 0.5,
        turbulence: 0.3,
        bubbling: 0.0,
        roar: 0.0,
        rivulets: 0.0,
      },
      layerDensity: {
        hardDrops: 1.2,
        waterDrops: 1.2,
        turbulence: 1.2,
        bubbling: 1.2,
        roar: 1.2,
        rivulets: 1.2,
      },
      insects: {
        density: 0.5,
        temperature: 0.5,
        distance: 0.3,
        space: 0.3,
        proximity: 0.5,
        antiphony: 0.3,
        clickRate: 0.3,
        motion: 0.5,
      },
      mix: {
        waterLevel: 0.7,
        insectsLevel: 0.7,
        space: 0.4,
        size: 0.5,
        night: 0,
      }
    };
    
    async function initAudio() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        console.log('AudioContext created, state:', audioContext.state, 'sampleRate:', audioContext.sampleRate);
        
        // Load worklets
        console.log('Loading water worklet...');
        await audioContext.audioWorklet.addModule('ARCHIVE/worklets/water.worklet.js');
        console.log('Loading ocean worklet...');
        await audioContext.audioWorklet.addModule('ARCHIVE/worklets/ocean.worklet.js');
        console.log('Loading insects worklet...');
        await audioContext.audioWorklet.addModule('ARCHIVE/worklets/insects.worklet.js');
        console.log('Loading reverb worklet...');
        await audioContext.audioWorklet.addModule('ARCHIVE/worklets/reverb.worklet.js');
        console.log('All worklets loaded!');
        
        // Create nodes with explicit stereo output
        waterNode = new AudioWorkletNode(audioContext, 'water-processor', {
          outputChannelCount: [2]
        });
        oceanNode = new AudioWorkletNode(audioContext, 'ocean-processor', {
          numberOfInputs: 0,
          numberOfOutputs: 1,
          outputChannelCount: [2]
        });
        insectsNode = new AudioWorkletNode(audioContext, 'insects-processor', {
          outputChannelCount: [2]
        });
        reverbNode = new AudioWorkletNode(audioContext, 'reverb');
        
        console.log('Worklet nodes created');
        
        // Gains
        masterGain = audioContext.createGain();
        masterGain.gain.value = 0.8;
        
        waterGain = audioContext.createGain();
        waterGain.gain.value = state.mix.waterLevel;
        console.log('waterGain value:', state.mix.waterLevel);

        oceanGain = audioContext.createGain();
        oceanGain.gain.value = state.ocean.enabled ? state.ocean.level * state.mix.waterLevel : 0;
        
        insectsGain = audioContext.createGain();
        insectsGain.gain.value = state.mix.insectsLevel;
        console.log('insectsGain value:', state.mix.insectsLevel);
        
        waterSendGain = audioContext.createGain();
        waterSendGain.gain.value = state.water.space;

        oceanSendGain = audioContext.createGain();
        oceanSendGain.gain.value = state.ocean.enabled ? state.ocean.level * state.water.space * state.water.reverbSend : 0;
        
        insectsSendGain = audioContext.createGain();
        insectsSendGain.gain.value = state.insects.space;
        
        // Night EQ filter
        nightFilter = audioContext.createBiquadFilter();
        nightFilter.type = 'lowpass';
        nightFilter.frequency.value = 20000;
        nightFilter.Q.value = 0.7;
        
        // Analysers for metering
        analyserL = audioContext.createAnalyser();
        analyserR = audioContext.createAnalyser();
        analyserL.fftSize = 256;
        analyserR.fftSize = 256;
        
        splitter = audioContext.createChannelSplitter(2);
        
        // Connect graph
        // Water -> waterGain -> nightFilter -> masterGain
        // Water -> waterSendGain -> reverb
        waterNode.connect(waterGain);
        waterNode.connect(waterSendGain);
        waterSendGain.connect(reverbNode);

        oceanNode.connect(oceanGain);
        oceanNode.connect(oceanSendGain);
        oceanSendGain.connect(reverbNode);
        
        // Insects -> insectsGain -> nightFilter -> masterGain
        // Insects -> insectsSendGain -> reverb
        insectsNode.connect(insectsGain);
        insectsNode.connect(insectsSendGain);
        insectsSendGain.connect(reverbNode);
        
        // Reverb -> nightFilter
        reverbNode.connect(nightFilter);
        
        // Direct paths
        waterGain.connect(nightFilter);
        oceanGain.connect(nightFilter);
        insectsGain.connect(nightFilter);
        
        // nightFilter -> masterGain -> analysers -> destination
        nightFilter.connect(masterGain);
        masterGain.connect(splitter);
        splitter.connect(analyserL, 0);
        splitter.connect(analyserR, 1);
        masterGain.connect(audioContext.destination);
        
        // Configure reverb
        reverbNode.port.postMessage({
          type: 'params',
          params: {
            type: 'hall',
            decay: 0.6,
            size: 1.2,
            damping: 0.4,
            diffusion: 0.8,
            modulation: 0.2,
            predelay: 20,
          }
        });
        
        // Set initial presets
        updateWaterPreset();
        updateOceanParams();
        updateInsectPreset();

        oceanNode.port.postMessage({ type: 'setSampleRate', sampleRate: audioContext.sampleRate });
        
        // Worklet message handlers
        waterNode.port.onmessage = (e) => {
          if (e.data.type === 'stats') {
            document.getElementById('dbg-water-voices').textContent = 
              `${e.data.activeVoices}/32`;
            document.getElementById('dbg-water-events').textContent = 
              e.data.eventsPerSecLow || 0;
          }
        };
        
        insectsNode.port.onmessage = (e) => {
          if (e.data.type === 'stats') {
            document.getElementById('dbg-insect-voices').textContent = e.data.activeVoices;
            document.getElementById('dbg-insect-engine').textContent = e.data.engineType || '--';
          }
        };
        
        document.getElementById('status').className = 'status ready';
        document.getElementById('status').textContent = 'Ready - Click Start to play';
        document.getElementById('dbg-sr').textContent = audioContext.sampleRate + ' Hz';
        
      } catch (err) {
        console.error('Audio init failed:', err);
        document.getElementById('status').className = 'status error';
        document.getElementById('status').textContent = 'Error: ' + err.message;
      }
    }
    
    function startAudio() {
      if (!audioContext) {
        console.error('No audio context!');
        return;
      }
      
      console.log('Starting audio, context state:', audioContext.state);
      
      if (audioContext.state === 'suspended') {
        audioContext.resume().then(() => {
          console.log('AudioContext resumed');
        });
      }
      
      console.log('Sending start messages to worklets');
      waterNode.port.postMessage({ type: 'start' });
      insectsNode.port.postMessage({ type: 'start' });
      
      isPlaying = true;
      document.getElementById('play-btn').classList.add('playing');
      document.getElementById('play-btn').textContent = '‚ñ∂ Playing';
      document.getElementById('status').className = 'status ready';
      document.getElementById('status').textContent = 'Playing...';
      
      requestAnimationFrame(updateMeters);
    }
    
    function stopAudio() {
      if (!audioContext) return;
      
      waterNode.port.postMessage({ type: 'stop' });
      insectsNode.port.postMessage({ type: 'stop' });
      
      isPlaying = false;
      document.getElementById('play-btn').classList.remove('playing');
      document.getElementById('play-btn').textContent = '‚ñ∂ Start';
      document.getElementById('status').className = 'status ready';
      document.getElementById('status').textContent = 'Stopped';
    }
    
    function updateWaterPreset() {
      if (!waterNode) return;
      
      waterNode.port.postMessage({ type: 'setPreset', preset: state.waterPreset });
      waterNode.port.postMessage({
        type: 'setParams',
        intensity: state.water.intensity,
        rate: state.water.rate,
        distance: state.water.distance,
        space: state.water.space,
        baseFreq: state.water.baseFreq,
        dropSize: state.water.dropSize,
        hardness: state.water.hardness,
        glassThickness: state.water.glassThickness,
      });
      
      // Send layer mix
      waterNode.port.postMessage({
        type: 'setLayerMix',
        hardDrops: state.layers.hardDrops,
        waterDrops: state.layers.waterDrops,
        turbulence: state.layers.turbulence,
        bubbling: state.layers.bubbling,
        roar: state.layers.roar,
        rivulets: state.layers.rivulets,
      });

      // Send layer density/activity
      waterNode.port.postMessage({
        type: 'setLayerDensity',
        hardDrops: state.layerDensity.hardDrops,
        waterDrops: state.layerDensity.waterDrops,
        turbulence: state.layerDensity.turbulence,
        bubbling: state.layerDensity.bubbling,
        roar: state.layerDensity.roar,
        rivulets: state.layerDensity.rivulets,
      });
      
      waterSendGain.gain.setTargetAtTime(state.water.space * state.water.reverbSend, audioContext.currentTime, 0.1);
      updateOceanParams();
      
      // Show/hide glass control for rain preset
      document.getElementById('water-glass-group').style.display = 
        state.waterPreset === 'rainWindow' ? 'block' : 'none';

      updateWaterFrequencyReadout();
    }

    function clamp(value, min, max) {
      return Math.min(max, Math.max(min, value));
    }

    function updateWaterFrequencyReadout() {
      const presetBase = WATER_PRESET_BASE_FREQ[state.waterPreset] || 2500;
      const activeBase = state.water.baseFreq || presetBase;

      const schedulerMin = activeBase * 0.5 * 0.6;
      const schedulerMax = activeBase * 0.5 * 1.4;

      const dropSize = clamp(state.water.dropSize, 0, 1);
      const freqScale = 1 - dropSize * 0.6;
      const voiceMin = schedulerMin * freqScale * 1.05;
      const voiceMax = schedulerMax * freqScale * 1.9;
      const preBpLow = Math.round(Math.min(voiceMin, voiceMax));
      const preBpHigh = Math.round(Math.max(voiceMin, voiceMax));

      const ampEstimate =
        state.mix.waterLevel *
        state.layers.waterDrops *
        state.layerDensity.waterDrops *
        (0.5 + state.water.intensity);

      document.getElementById('water-live-preset-base').textContent = `${Math.round(presetBase)} Hz`;
      document.getElementById('water-live-active-base').textContent = `${Math.round(activeBase)} Hz`;
      document.getElementById('water-live-drop-range').textContent = `${preBpLow}‚Äì${preBpHigh} Hz`;
      document.getElementById('water-live-bp-range').textContent = `${WATER_DROP_BANDPASS.highpass}‚Äì${WATER_DROP_BANDPASS.lowpass} Hz`;
      document.getElementById('water-live-amp').textContent = `${ampEstimate.toFixed(2)}x`;
    }
    
    function updateInsectPreset() {
      if (!insectsNode) return;

      const clamp01 = (v) => Math.max(0, Math.min(1, v));
      const speciesProfiles = {
        cricket: { density: 1.0, temperature: 1.0, clickRate: 0.45, antiphony: 0.2, proximity: 1.0, motion: 0.15 },
        treeCricket: { density: 0.65, temperature: 1.05, clickRate: 0.12, antiphony: 0.05, proximity: 0.75, motion: 0.02 },
        katydid: { density: 0.95, temperature: 0.85, clickRate: 0.35, antiphony: 1.0, proximity: 0.75, motion: 0.1 },
        cicada: { density: 0.9, temperature: 0.9, clickRate: 1.0, antiphony: 0.05, proximity: 0.5, motion: 0.05 },
        grasshopper: { density: 0.75, temperature: 0.95, clickRate: 0.6, antiphony: 0.1, proximity: 0.65, motion: 0.2 },
        flyBee: { density: 0.95, temperature: 0.65, clickRate: 0.2, antiphony: 0.0, proximity: 0.8, motion: 1.0 },
        moleCricket: { density: 0.7, temperature: 0.85, clickRate: 0.45, antiphony: 0.1, proximity: 0.7, motion: 0.1 },
      };

      const profile = speciesProfiles[state.insectPreset] || speciesProfiles.cricket;
      const mappedParams = {
        density: clamp01(state.insects.density * profile.density),
        temperature: clamp01(state.insects.temperature * profile.temperature),
        distance: state.insects.distance,
        space: state.insects.space,
        proximity: clamp01(state.insects.proximity * profile.proximity),
        antiphony: clamp01(state.insects.antiphony * profile.antiphony),
        clickRate: clamp01(state.insects.clickRate * profile.clickRate),
        motion: clamp01(state.insects.motion * profile.motion),
      };
      
      insectsNode.port.postMessage({ type: 'setEngine', engine: state.insectPreset });
      insectsNode.port.postMessage({
        type: 'setParams',
        density: mappedParams.density,
        temperature: mappedParams.temperature,
        distance: mappedParams.distance,
        space: mappedParams.space,
        proximity: mappedParams.proximity,
        antiphony: mappedParams.antiphony,
        clickRate: mappedParams.clickRate,
        motion: mappedParams.motion,
      });
      
      insectsSendGain.gain.setTargetAtTime(state.insects.space * 0.5, audioContext.currentTime, 0.1);
      
      // Show/hide preset-specific controls
      document.getElementById('insect-proximity-group').style.display = 
        (state.insectPreset === 'cricket' || state.insectPreset === 'treeCricket') ? 'block' : 'none';
      document.getElementById('insect-antiphony-group').style.display = 
        state.insectPreset === 'katydid' ? 'block' : 'none';
      document.getElementById('insect-clickrate-group').style.display = 
        (state.insectPreset === 'cicada' || state.insectPreset === 'grasshopper' || state.insectPreset === 'moleCricket') ? 'block' : 'none';
      document.getElementById('insect-motion-group').style.display = 
        state.insectPreset === 'flyBee' ? 'block' : 'none';
    }

    function updateOceanParams() {
      if (!audioContext || !oceanNode || !oceanGain || !oceanSendGain) return;

      const now = audioContext.currentTime;
      const smooth = 0.1;
      const oceanLevel = state.ocean.enabled ? state.ocean.level : 0;
      const effectiveIntensity = oceanLevel > 0.0001 ? state.ocean.intensity : 0;

      oceanGain.gain.setTargetAtTime(oceanLevel * state.mix.waterLevel, now, smooth);
      oceanSendGain.gain.setTargetAtTime(oceanLevel * state.water.space * state.water.reverbSend, now, smooth);

      const oceanParams = oceanNode.parameters;
      Object.keys(state.ocean).forEach((key) => {
        if (key === 'enabled' || key === 'level') return;
        const param = oceanParams.get(key);
        if (!param) return;
        if (key === 'intensity') {
          param.setTargetAtTime(effectiveIntensity, now, smooth);
        } else {
          param.setTargetAtTime(state.ocean[key], now, smooth);
        }
      });
    }
    
    function updateMixParams() {
      if (!audioContext) return;
      
      waterGain.gain.setTargetAtTime(state.mix.waterLevel, audioContext.currentTime, 0.1);
      insectsGain.gain.setTargetAtTime(state.mix.insectsLevel, audioContext.currentTime, 0.1);
      updateOceanParams();
      
      // Update reverb
      reverbNode.port.postMessage({
        type: 'params',
        params: {
          decay: 0.4 + state.mix.space * 0.5,
          size: 0.8 + state.mix.size * 1.2,
          damping: 0.3 + (1 - state.mix.space) * 0.4,
        }
      });
      
      // Night EQ
      const nightFreq = 20000 - state.mix.night * 15000;
      nightFilter.frequency.setTargetAtTime(nightFreq, audioContext.currentTime, 0.1);
    }
    
    // Metering
    let peakL = 0, peakR = 0;
    let rmsL = 0, rmsR = 0;
    const peakDecay = 0.95;
    
    function updateMeters() {
      if (!isPlaying || !analyserL) return;
      
      const bufferL = new Float32Array(analyserL.fftSize);
      const bufferR = new Float32Array(analyserR.fftSize);
      analyserL.getFloatTimeDomainData(bufferL);
      analyserR.getFloatTimeDomainData(bufferR);
      
      // Calculate peak and RMS
      let sumL = 0, sumR = 0;
      let maxL = 0, maxR = 0;
      
      for (let i = 0; i < bufferL.length; i++) {
        const absL = Math.abs(bufferL[i]);
        const absR = Math.abs(bufferR[i]);
        sumL += bufferL[i] * bufferL[i];
        sumR += bufferR[i] * bufferR[i];
        if (absL > maxL) maxL = absL;
        if (absR > maxR) maxR = absR;
      }
      
      // RMS
      rmsL = Math.sqrt(sumL / bufferL.length);
      rmsR = Math.sqrt(sumR / bufferR.length);
      
      // Peak with decay
      if (maxL > peakL) peakL = maxL;
      else peakL *= peakDecay;
      if (maxR > peakR) peakR = maxR;
      else peakR *= peakDecay;
      
      // Update debug panel
      const toDb = (v) => v > 0.00001 ? (20 * Math.log10(v)).toFixed(1) : '-‚àû';
      document.getElementById('dbg-peak').textContent = `${toDb(peakL)} / ${toDb(peakR)}`;
      document.getElementById('dbg-rms').textContent = `${toDb(rmsL)} / ${toDb(rmsR)}`;
      
      // Update meter bars (convert to 0-100%)
      const toPercent = (v) => Math.min(100, Math.max(0, (1 + toDb(v) / 60) * 100));
      document.getElementById('meter-fill-l').style.height = toPercent(rmsL) + '%';
      document.getElementById('meter-fill-r').style.height = toPercent(rmsR) + '%';
      document.getElementById('meter-peak-l').style.bottom = toPercent(peakL) + '%';
      document.getElementById('meter-peak-r').style.bottom = toPercent(peakR) + '%';
      
      // Check peak warnings
      const peakEl = document.getElementById('dbg-peak');
      if (peakL > 0.9 || peakR > 0.9) {
        peakEl.className = 'value error';
      } else if (peakL > 0.7 || peakR > 0.7) {
        peakEl.className = 'value warn';
      } else {
        peakEl.className = 'value';
      }
      
      requestAnimationFrame(updateMeters);
    }
    
    // Poll worklet stats
    function pollStats() {
      if (!waterNode || !insectsNode) return;
      
      waterNode.port.postMessage({ type: 'getStats' });
      insectsNode.port.postMessage({ type: 'getStats' });
    }
    
    // ============================================
    // UI EVENT HANDLERS
    // ============================================
    
    document.addEventListener('DOMContentLoaded', () => {
      initAudio();
      
      // Poll stats periodically
      setInterval(pollStats, 500);
      
      // Transport
      document.getElementById('play-btn').onclick = () => {
        if (isPlaying) return;
        startAudio();
      };
      document.getElementById('stop-btn').onclick = stopAudio;
      
      // Tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
        };
      });
      
      // Water presets - with layer defaults
      const presetLayers = {
        tapDrips: { hardDrops: 0.7, waterDrops: 0.5, turbulence: 0.3, bubbling: 0.0, roar: 0.0, rivulets: 0.0 },
        stream: { hardDrops: 0.08, waterDrops: 0.82, turbulence: 0.56, bubbling: 0.92, roar: 0.0, rivulets: 0.0 },
        waterfall: { hardDrops: 0.1, waterDrops: 0.3, turbulence: 0.4, bubbling: 0.4, roar: 1.0, rivulets: 0.0 },
        rainWindow: { hardDrops: 0.32, waterDrops: 0.42, turbulence: 0.18, bubbling: 0.0, roar: 0.0, rivulets: 0.92 },
      };
      
      function updateLayerSliders() {
        const layers = state.layers;
        document.getElementById('layer-harddrops').value = layers.hardDrops;
        document.getElementById('layer-harddrops-val').textContent = Math.round(layers.hardDrops * 100) + '%';
        document.getElementById('layer-waterdrops').value = layers.waterDrops;
        document.getElementById('layer-waterdrops-val').textContent = Math.round(layers.waterDrops * 100) + '%';
        document.getElementById('layer-turbulence').value = layers.turbulence;
        document.getElementById('layer-turbulence-val').textContent = Math.round(layers.turbulence * 100) + '%';
        document.getElementById('layer-bubbling').value = layers.bubbling;
        document.getElementById('layer-bubbling-val').textContent = Math.round(layers.bubbling * 100) + '%';
        document.getElementById('layer-roar').value = layers.roar;
        document.getElementById('layer-roar-val').textContent = Math.round(layers.roar * 100) + '%';
        document.getElementById('layer-rivulets').value = layers.rivulets;
        document.getElementById('layer-rivulets-val').textContent = Math.round(layers.rivulets * 100) + '%';
      }

      function updateLayerDensitySliders() {
        const density = state.layerDensity;
        document.getElementById('density-harddrops').value = density.hardDrops;
        document.getElementById('density-harddrops-val').textContent = Math.round(density.hardDrops * 100) + '%';
        document.getElementById('density-waterdrops').value = density.waterDrops;
        document.getElementById('density-waterdrops-val').textContent = Math.round(density.waterDrops * 100) + '%';
        document.getElementById('density-turbulence').value = density.turbulence;
        document.getElementById('density-turbulence-val').textContent = Math.round(density.turbulence * 100) + '%';
        document.getElementById('density-bubbling').value = density.bubbling;
        document.getElementById('density-bubbling-val').textContent = Math.round(density.bubbling * 100) + '%';
        document.getElementById('density-roar').value = density.roar;
        document.getElementById('density-roar-val').textContent = Math.round(density.roar * 100) + '%';
        document.getElementById('density-rivulets').value = density.rivulets;
        document.getElementById('density-rivulets-val').textContent = Math.round(density.rivulets * 100) + '%';
      }

      function applyWaterBoostSettings() {
        if (waterBoostEnabled) {
          state.layers.waterDrops = 1.5;
          state.layers.bubbling = 1.5;

          state.layerDensity.hardDrops = 1.2;
          state.layerDensity.waterDrops = 1.2;
          state.layerDensity.turbulence = 1.2;
          state.layerDensity.bubbling = 1.2;
          state.layerDensity.roar = 1.2;
          state.layerDensity.rivulets = 1.2;
        } else {
          state.layers.waterDrops = 0.5;
          state.layers.bubbling = 0.0;

          state.layerDensity.hardDrops = 0.5;
          state.layerDensity.waterDrops = 0.5;
          state.layerDensity.turbulence = 0.5;
          state.layerDensity.bubbling = 0.5;
          state.layerDensity.roar = 0.5;
          state.layerDensity.rivulets = 0.5;
        }
      }
      
      document.querySelectorAll('#water-presets .preset-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('#water-presets .preset-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.waterPreset = btn.dataset.preset;
          state.water.baseFreq = WATER_PRESET_BASE_FREQ[state.waterPreset] || state.water.baseFreq;
          // Update layer state from preset
          if (presetLayers[state.waterPreset]) {
            state.layers = { ...presetLayers[state.waterPreset] };
            applyWaterBoostSettings();
            updateLayerSliders();
            updateLayerDensitySliders();
          }
          document.getElementById('water-basefreq').value = state.water.baseFreq;
          document.getElementById('water-basefreq-val').textContent = `${Math.round(state.water.baseFreq)} Hz`;
          updateWaterPreset();
        };
      });
      
      // Insect presets
      document.querySelectorAll('#insect-presets .preset-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('#insect-presets .preset-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.insectPreset = btn.dataset.preset;
          updateInsectPreset();
        };
      });
      
      // Water controls
      const waterControls = ['intensity', 'rate', 'distance', 'space', 'send', 'basefreq', 'dropsize', 'hardness', 'glass'];
      waterControls.forEach(name => {
        const el = document.getElementById('water-' + name);
        if (!el) return;
        el.oninput = () => {
          const val = parseFloat(el.value);
          const isFrequency = name === 'basefreq';
          document.getElementById('water-' + name + '-val').textContent = isFrequency
            ? `${Math.round(val)} Hz`
            : Math.round(val * 100) + '%';
          
          const keyMap = {
            send: 'reverbSend',
            basefreq: 'baseFreq',
            dropsize: 'dropSize',
            glass: 'glassThickness',
          };
          const key = keyMap[name] || name;
          state.water[key] = val;
          updateWaterPreset();
        };
      });
      
      // Insect controls
      const insectControls = ['density', 'temp', 'distance', 'space', 'proximity', 'antiphony', 'clickrate', 'motion'];
      insectControls.forEach(name => {
        const el = document.getElementById('insect-' + name);
        if (!el) return;
        el.oninput = () => {
          const val = parseFloat(el.value);
          document.getElementById('insect-' + name + '-val').textContent = Math.round(val * 100) + '%';
          
          const keyMap = {
            temp: 'temperature',
            clickrate: 'clickRate',
          };
          const key = keyMap[name] || name;
          state.insects[key] = val;
          updateInsectPreset();
        };
      });
      
      // Mix controls
      const mixControls = ['water', 'insects', 'space', 'size', 'night'];
      mixControls.forEach(name => {
        const el = document.getElementById('mix-' + name);
        if (!el) return;
        el.oninput = () => {
          const val = parseFloat(el.value);
          document.getElementById('mix-' + name + '-val').textContent = Math.round(val * 100) + '%';
          
          const keyMap = {
            water: 'waterLevel',
            insects: 'insectsLevel',
          };
          const key = keyMap[name] || name;
          state.mix[key] = val;
          updateMixParams();
          if (key === 'waterLevel') {
            updateWaterFrequencyReadout();
          }
        };
      });
      
      // Advanced toggles
      document.getElementById('water-advanced-toggle').onclick = function() {
        this.classList.toggle('open');
        document.getElementById('water-advanced').classList.toggle('open');
      };
      document.getElementById('water-layers-toggle').onclick = function() {
        this.classList.toggle('open');
        document.getElementById('water-layers').classList.toggle('open');
      };
      document.getElementById('water-ocean-toggle').onclick = function() {
        this.classList.toggle('open');
        document.getElementById('water-ocean').classList.toggle('open');
      };
      document.getElementById('insect-advanced-toggle').onclick = function() {
        this.classList.toggle('open');
        document.getElementById('insect-advanced').classList.toggle('open');
      };

      const formatOceanValue = (key, val) => {
        if (key.endsWith('FreqMin') || key.endsWith('FreqMax')) return `${Math.round(val)} Hz`;
        if (key === 'waveDurationMin' || key === 'waveDurationMax' || key === 'waveIntervalMin' || key === 'waveIntervalMax' || key === 'wave2OffsetMin' || key === 'wave2OffsetMax') {
          return Number(val).toFixed(2);
        }
        if (key === 'level') return `${Math.round(val * 100)}%`;
        return `${Math.round(val * 100)}%`;
      };

      document.getElementById('ocean-enabled').onchange = function() {
        state.ocean.enabled = this.checked;
        updateOceanParams();
      };

      const oceanControls = [
        'level', 'intensity', 'waveDurationMin', 'waveDurationMax', 'waveIntervalMin', 'waveIntervalMax',
        'wave2OffsetMin', 'wave2OffsetMax', 'foamMin', 'foamMax', 'depthMin', 'depthMax'
      ];
      oceanControls.forEach((key) => {
        const el = document.getElementById(`ocean-${key}`);
        if (!el) return;
        el.oninput = () => {
          const val = parseFloat(el.value);
          state.ocean[key] = val;
          const valueEl = document.getElementById(`ocean-${key}-val`);
          if (valueEl) valueEl.textContent = formatOceanValue(key, val);
          updateOceanParams();
        };
      });
      
      // Layer mix sliders
      const layerSliders = [
        { id: 'layer-harddrops', key: 'hardDrops' },
        { id: 'layer-waterdrops', key: 'waterDrops' },
        { id: 'layer-turbulence', key: 'turbulence' },
        { id: 'layer-bubbling', key: 'bubbling' },
        { id: 'layer-roar', key: 'roar' },
        { id: 'layer-rivulets', key: 'rivulets' },
      ];
      layerSliders.forEach(({ id, key }) => {
        const slider = document.getElementById(id);
        const valSpan = document.getElementById(id + '-val');
        slider.oninput = function() {
          const val = parseFloat(this.value);
          state.layers[key] = val;
          valSpan.textContent = Math.round(val * 100) + '%';
          if (waterNode) {
            waterNode.port.postMessage({
              type: 'setLayerMix',
              [key]: val,
            });
          }
          updateWaterFrequencyReadout();
        };
      });

      // Layer density sliders
      const layerDensitySliders = [
        { id: 'density-harddrops', key: 'hardDrops' },
        { id: 'density-waterdrops', key: 'waterDrops' },
        { id: 'density-turbulence', key: 'turbulence' },
        { id: 'density-bubbling', key: 'bubbling' },
        { id: 'density-roar', key: 'roar' },
        { id: 'density-rivulets', key: 'rivulets' },
      ];
      layerDensitySliders.forEach(({ id, key }) => {
        const slider = document.getElementById(id);
        const valSpan = document.getElementById(id + '-val');
        slider.oninput = function() {
          const val = parseFloat(this.value);
          state.layerDensity[key] = val;
          valSpan.textContent = Math.round(val * 100) + '%';
          if (waterNode) {
            waterNode.port.postMessage({
              type: 'setLayerDensity',
              [key]: val,
            });
          }
          updateWaterFrequencyReadout();
        };
      });

      // One-click boost for quick A/B
      document.getElementById('water-boost-toggle').onclick = () => {
        waterBoostEnabled = !waterBoostEnabled;
        applyWaterBoostSettings();

        updateUIFromState();
        updateWaterPreset();

        const btn = document.getElementById('water-boost-toggle');
        btn.textContent = waterBoostEnabled ? '‚ö° Water Boost: On' : '‚ö° Water Boost: Off';
      };

      // Apply default-on boost once at startup
      applyWaterBoostSettings();
      updateUIFromState();
      updateWaterFrequencyReadout();
      updateWaterPreset();
      
      // Debug panel toggle
      document.getElementById('debug-toggle').onclick = () => {
        document.getElementById('debug-panel').classList.toggle('visible');
      };
      
      // Seed controls
      document.getElementById('seed-apply').onclick = () => {
        currentSeed = parseInt(document.getElementById('seed-input').value) || Date.now();
        if (waterNode) waterNode.port.postMessage({ type: 'setSeed', seed: currentSeed });
        if (oceanNode) oceanNode.port.postMessage({ type: 'setSeed', seed: currentSeed });
        if (insectsNode) insectsNode.port.postMessage({ type: 'setSeed', seed: currentSeed });
      };
      document.getElementById('seed-random').onclick = () => {
        currentSeed = Math.floor(Math.random() * 1000000);
        document.getElementById('seed-input').value = currentSeed;
        if (waterNode) waterNode.port.postMessage({ type: 'setSeed', seed: currentSeed });
        if (oceanNode) oceanNode.port.postMessage({ type: 'setSeed', seed: currentSeed });
        if (insectsNode) insectsNode.port.postMessage({ type: 'setSeed', seed: currentSeed });
      };
      
      // Save/Load presets
      document.getElementById('save-preset').onclick = () => {
        const preset = {
          version: 1,
          seed: currentSeed,
          waterPreset: state.waterPreset,
          insectPreset: state.insectPreset,
          water: { ...state.water },
          ocean: { ...state.ocean },
          layers: { ...state.layers },
          layerDensity: { ...state.layerDensity },
          insects: { ...state.insects },
          mix: { ...state.mix },
        };
        
        const blob = new Blob([JSON.stringify(preset, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'soundscape-preset.json';
        a.click();
        URL.revokeObjectURL(url);
      };
      
      document.getElementById('load-preset').onclick = () => {
        document.getElementById('load-file').click();
      };
      
      document.getElementById('load-file').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const preset = JSON.parse(ev.target.result);
            
            if (preset.seed) {
              currentSeed = preset.seed;
              document.getElementById('seed-input').value = currentSeed;
            }
            
            if (preset.waterPreset) {
              state.waterPreset = preset.waterPreset;
              document.querySelectorAll('#water-presets .preset-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.preset === state.waterPreset);
              });
            }
            
            if (preset.insectPreset) {
              state.insectPreset = preset.insectPreset;
              document.querySelectorAll('#insect-presets .preset-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.preset === state.insectPreset);
              });
            }
            
            if (preset.water) Object.assign(state.water, preset.water);
            if (preset.ocean) Object.assign(state.ocean, preset.ocean);
            if (preset.layers) Object.assign(state.layers, preset.layers);
            if (preset.layerDensity) Object.assign(state.layerDensity, preset.layerDensity);
            if (preset.insects) Object.assign(state.insects, preset.insects);
            if (preset.mix) Object.assign(state.mix, preset.mix);
            
            // Update UI
            updateUIFromState();
            updateWaterPreset();
            updateOceanParams();
            updateInsectPreset();
            updateMixParams();
            
          } catch (err) {
            alert('Error loading preset: ' + err.message);
          }
        };
        reader.readAsText(file);
      };
      
      document.getElementById('copy-preset').onclick = () => {
        const preset = {
          version: 1,
          seed: currentSeed,
          waterPreset: state.waterPreset,
          insectPreset: state.insectPreset,
          water: { ...state.water },
          ocean: { ...state.ocean },
          layers: { ...state.layers },
          layerDensity: { ...state.layerDensity },
          insects: { ...state.insects },
          mix: { ...state.mix },
        };
        
        navigator.clipboard.writeText(JSON.stringify(preset, null, 2)).then(() => {
          const btn = document.getElementById('copy-preset');
          btn.textContent = '‚úì Copied!';
          setTimeout(() => { btn.textContent = 'üìã Copy to Clipboard'; }, 2000);
        });
      };
    });
    
    function updateUIFromState() {
      // Water
      document.getElementById('water-intensity').value = state.water.intensity;
      document.getElementById('water-intensity-val').textContent = Math.round(state.water.intensity * 100) + '%';
      document.getElementById('water-rate').value = state.water.rate;
      document.getElementById('water-rate-val').textContent = Math.round(state.water.rate * 100) + '%';
      document.getElementById('water-distance').value = state.water.distance;
      document.getElementById('water-distance-val').textContent = Math.round(state.water.distance * 100) + '%';
      document.getElementById('water-space').value = state.water.space;
      document.getElementById('water-space-val').textContent = Math.round(state.water.space * 100) + '%';
      document.getElementById('water-send').value = state.water.reverbSend;
      document.getElementById('water-send-val').textContent = Math.round(state.water.reverbSend * 100) + '%';
      document.getElementById('water-basefreq').value = state.water.baseFreq;
      document.getElementById('water-basefreq-val').textContent = `${Math.round(state.water.baseFreq)} Hz`;
      document.getElementById('water-dropsize').value = state.water.dropSize;
      document.getElementById('water-dropsize-val').textContent = Math.round(state.water.dropSize * 100) + '%';
      document.getElementById('water-hardness').value = state.water.hardness;
      document.getElementById('water-hardness-val').textContent = Math.round(state.water.hardness * 100) + '%';
      document.getElementById('water-glass').value = state.water.glassThickness;
      document.getElementById('water-glass-val').textContent = Math.round(state.water.glassThickness * 100) + '%';

      // Ocean
      document.getElementById('ocean-enabled').checked = !!state.ocean.enabled;
      const oceanControls = [
        'level', 'intensity', 'waveDurationMin', 'waveDurationMax', 'waveIntervalMin', 'waveIntervalMax',
        'wave2OffsetMin', 'wave2OffsetMax', 'foamMin', 'foamMax', 'depthMin', 'depthMax'
      ];
      oceanControls.forEach((key) => {
        const slider = document.getElementById(`ocean-${key}`);
        const valueEl = document.getElementById(`ocean-${key}-val`);
        if (!slider || !valueEl) return;
        const val = state.ocean[key];
        slider.value = val;
        if (key.endsWith('FreqMin') || key.endsWith('FreqMax')) valueEl.textContent = `${Math.round(val)} Hz`;
        else if (key === 'waveDurationMin' || key === 'waveDurationMax' || key === 'waveIntervalMin' || key === 'waveIntervalMax' || key === 'wave2OffsetMin' || key === 'wave2OffsetMax') valueEl.textContent = Number(val).toFixed(2);
        else valueEl.textContent = `${Math.round(val * 100)}%`;
      });

      // Layer mix
      document.getElementById('layer-harddrops').value = state.layers.hardDrops;
      document.getElementById('layer-harddrops-val').textContent = Math.round(state.layers.hardDrops * 100) + '%';
      document.getElementById('layer-waterdrops').value = state.layers.waterDrops;
      document.getElementById('layer-waterdrops-val').textContent = Math.round(state.layers.waterDrops * 100) + '%';
      document.getElementById('layer-turbulence').value = state.layers.turbulence;
      document.getElementById('layer-turbulence-val').textContent = Math.round(state.layers.turbulence * 100) + '%';
      document.getElementById('layer-bubbling').value = state.layers.bubbling;
      document.getElementById('layer-bubbling-val').textContent = Math.round(state.layers.bubbling * 100) + '%';
      document.getElementById('layer-roar').value = state.layers.roar;
      document.getElementById('layer-roar-val').textContent = Math.round(state.layers.roar * 100) + '%';
      document.getElementById('layer-rivulets').value = state.layers.rivulets;
      document.getElementById('layer-rivulets-val').textContent = Math.round(state.layers.rivulets * 100) + '%';

      // Layer density
      document.getElementById('density-harddrops').value = state.layerDensity.hardDrops;
      document.getElementById('density-harddrops-val').textContent = Math.round(state.layerDensity.hardDrops * 100) + '%';
      document.getElementById('density-waterdrops').value = state.layerDensity.waterDrops;
      document.getElementById('density-waterdrops-val').textContent = Math.round(state.layerDensity.waterDrops * 100) + '%';
      document.getElementById('density-turbulence').value = state.layerDensity.turbulence;
      document.getElementById('density-turbulence-val').textContent = Math.round(state.layerDensity.turbulence * 100) + '%';
      document.getElementById('density-bubbling').value = state.layerDensity.bubbling;
      document.getElementById('density-bubbling-val').textContent = Math.round(state.layerDensity.bubbling * 100) + '%';
      document.getElementById('density-roar').value = state.layerDensity.roar;
      document.getElementById('density-roar-val').textContent = Math.round(state.layerDensity.roar * 100) + '%';
      document.getElementById('density-rivulets').value = state.layerDensity.rivulets;
      document.getElementById('density-rivulets-val').textContent = Math.round(state.layerDensity.rivulets * 100) + '%';
      
      // Insects
      document.getElementById('insect-density').value = state.insects.density;
      document.getElementById('insect-density-val').textContent = Math.round(state.insects.density * 100) + '%';
      document.getElementById('insect-temp').value = state.insects.temperature;
      document.getElementById('insect-temp-val').textContent = Math.round(state.insects.temperature * 100) + '%';
      document.getElementById('insect-distance').value = state.insects.distance;
      document.getElementById('insect-distance-val').textContent = Math.round(state.insects.distance * 100) + '%';
      document.getElementById('insect-space').value = state.insects.space;
      document.getElementById('insect-space-val').textContent = Math.round(state.insects.space * 100) + '%';
      document.getElementById('insect-proximity').value = state.insects.proximity;
      document.getElementById('insect-proximity-val').textContent = Math.round(state.insects.proximity * 100) + '%';
      document.getElementById('insect-antiphony').value = state.insects.antiphony;
      document.getElementById('insect-antiphony-val').textContent = Math.round(state.insects.antiphony * 100) + '%';
      document.getElementById('insect-clickrate').value = state.insects.clickRate;
      document.getElementById('insect-clickrate-val').textContent = Math.round(state.insects.clickRate * 100) + '%';
      document.getElementById('insect-motion').value = state.insects.motion;
      document.getElementById('insect-motion-val').textContent = Math.round(state.insects.motion * 100) + '%';
      
      // Mix
      document.getElementById('mix-water').value = state.mix.waterLevel;
      document.getElementById('mix-water-val').textContent = Math.round(state.mix.waterLevel * 100) + '%';
      document.getElementById('mix-insects').value = state.mix.insectsLevel;
      document.getElementById('mix-insects-val').textContent = Math.round(state.mix.insectsLevel * 100) + '%';
      document.getElementById('mix-space').value = state.mix.space;
      document.getElementById('mix-space-val').textContent = Math.round(state.mix.space * 100) + '%';
      document.getElementById('mix-size').value = state.mix.size;
      document.getElementById('mix-size-val').textContent = Math.round(state.mix.size * 100) + '%';
      document.getElementById('mix-night').value = state.mix.night;
      document.getElementById('mix-night-val').textContent = Math.round(state.mix.night * 100) + '%';

      updateWaterFrequencyReadout();
    }
    
    // Keyboard shortcut
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
        e.preventDefault();
        if (isPlaying) stopAudio();
        else startAudio();
      }
    });
  </script>
</body>
</html>
